name: Combined CI Workflow

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: '22 0 * * 4'

jobs:
  build:
    runs-on: ubuntu-latest

    services:
      ipfs:
        image: ipfs/go-ipfs:latest
        ports:
          - 5001:5001

    strategy:
      matrix:
        language: [rust, go, python, nodejs]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache
            ./build
          key: ${{ runner.os }}-build-${{ hashFiles('**/configure', '**/Makefile.am', '**/Makefile.in', '**/Cargo.lock', '**/go.sum', '**/requirements.txt', '**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Set up dependencies
        run: sudo apt-get update && sudo apt-get install -y build-essential autoconf automake libtool cmake

      # Rust setup and build
      - name: Install rustup
        if: matrix.language == 'rust'
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env

      - name: Set up Rust nightly toolchain
        if: matrix.language == 'rust'
        run: |
          rustup default nightly
          rustup component add rust-src --toolchain nightly

      - name: Build with cargo
        if: matrix.language == 'rust'
        run: |
          make setup-rust
          make build-rust
          make test-rust

      # Go setup and build
      - name: Set up Go
        if: matrix.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.22.0'

      - name: Build with go
        if: matrix.language == 'go'
        run: |
          make setup-go
          make build-go
          make test-go

      # Python setup and build
      - name: Set up Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Build with Python
        if: matrix.language == 'python'
        run: |
          make setup-python
          make build-python
          make test-python

      # Node.js setup and build
      - name: Set up Node.js
        if: matrix.language == 'nodejs'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build with npm
        if: matrix.language == 'nodejs'
        run: |
          make setup-node
          make build-node
          make test-node

  rust-clippy-analyze:
    name: Run rust-clippy analyzing
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy
          override: true

      - name: Install required cargo
        run: cargo install clippy-sarif sarif-fmt

      - name: Run rust-clippy
        run: |
          cargo clippy --all-features --message-format=json | clippy-sarif | tee rust-clippy-results.sarif | sarif-fmt
        continue-on-error: true

      - name: Upload analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v1
        with:
          sarif_file: rust-clippy-results.sarif
          wait-for-processing: true
